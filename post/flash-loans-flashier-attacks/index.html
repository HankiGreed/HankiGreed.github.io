<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Flash Loans, Flashier Attacks ! - Blogchain - A Blockchain Blog</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="Kiran Hegde"><meta name=description content="Most of the content in this post is either from or inspired by this paper. If you would rather read it, go ahead and skip this post.
 Decentralized Finance. Decentralized Finance is an effort to bring the benefits of distributed ledger technologies to the real world of finance. Instead of the financial institution knowing their customers to ensure their trust is well placed, you are able to transparently view all of the Smart Contracts, security practices, security audits to effectively Know Your Bank."><meta name=keywords content="defi,aave,bzx"><meta name=generator content="Hugo 0.74.2 with theme even"><link rel=canonical href=http://blogchain.wtf/post/flash-loans-flashier-attacks/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/fork-awesome@1.1.7/css/fork-awesome.min.css integrity="sha256-gsmEoJAws/Kd3CjuOQzLie5Q3yshhvmo7YNtBG7aaEY=" crossorigin=anonymous><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png?><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png?><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png?><link rel=manifest href=../../manifest.json><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><link href=../../sass/main.min.4eb71590ad024de2ebb1b5eef94cbb645b7e63e6b9c4c837355530a75e112ce1.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="Flash Loans, Flashier Attacks !"><meta property="og:description" content="Most of the content in this post is either from or inspired by this paper. If you would rather read it, go ahead and skip this post.
 Decentralized Finance. Decentralized Finance is an effort to bring the benefits of distributed ledger technologies to the real world of finance. Instead of the financial institution knowing their customers to ensure their trust is well placed, you are able to transparently view all of the Smart Contracts, security practices, security audits to effectively Know Your Bank."><meta property="og:type" content="article"><meta property="og:url" content="http://blogchain.wtf/post/flash-loans-flashier-attacks/"><meta property="article:published_time" content="2020-07-15T09:55:29+05:30"><meta property="article:modified_time" content="2020-07-15T09:55:29+05:30"><meta itemprop=name content="Flash Loans, Flashier Attacks !"><meta itemprop=description content="Most of the content in this post is either from or inspired by this paper. If you would rather read it, go ahead and skip this post.
 Decentralized Finance. Decentralized Finance is an effort to bring the benefits of distributed ledger technologies to the real world of finance. Instead of the financial institution knowing their customers to ensure their trust is well placed, you are able to transparently view all of the Smart Contracts, security practices, security audits to effectively Know Your Bank."><meta itemprop=datePublished content="2020-07-15T09:55:29+05:30"><meta itemprop=dateModified content="2020-07-15T09:55:29+05:30"><meta itemprop=wordCount content="867"><meta itemprop=keywords content="defi,security,aave,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Flash Loans, Flashier Attacks !"><meta name=twitter:description content="Most of the content in this post is either from or inspired by this paper. If you would rather read it, go ahead and skip this post.
 Decentralized Finance. Decentralized Finance is an effort to bring the benefits of distributed ledger technologies to the real world of finance. Instead of the financial institution knowing their customers to ensure their trust is well placed, you are able to transparently view all of the Smart Contracts, security practices, security audits to effectively Know Your Bank."><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=../../ class=logo><i class="fa fa-ethereum"></i>Blogchain</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=../../><li class=mobile-menu-item>Home</li></a><a href=../../post/><li class=mobile-menu-item>Posts</li></a><a href=../../tags/><li class=mobile-menu-item>Tags</li></a><a href=../../categories/><li class=mobile-menu-item>Categories</li></a><a href=../../about/><li class=mobile-menu-item>About</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=../../ class=logo><i class="fa fa-ethereum" aria-hidden=true></i>Blogchain</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=../../>Home</a></li><li class=menu-item><a class=menu-item-link href=../../post/>Posts</a></li><li class=menu-item><a class=menu-item-link href=../../tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=../../categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=../../about/>About</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Flash Loans, Flashier Attacks !</h1><div class=post-meta><span class=post-time>2020-07-15</span><div class=post-category><a href=../../categories/defi/>DeFi</a>
<a href=../../categories/security/>Security</a></div><span class=more-meta>867 words</span>
<span class=more-meta>5 mins read</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#decentralized-finance>Decentralized Finance.</a></li><li><a href=#flash-loans-the-new-kid-on-the-defi-block-well-relatively->Flash Loans, The New Kid on the DeFi Block. <em>(Well Relatively !)</em></a><ul><li><a href=#okay--if-that-is-possible-then-whats-the-catch->Okay , If that is possible, then what&rsquo;s the catch ?</a></li><li><a href=#if-we-return-the-money-as-soon-as-we-borrow-whats-the-use->If we return the money as soon as we borrow, What&rsquo;s the use ?</a></li></ul></li><li><a href=#attack-1-pump-and-dump>Attack #1 (Pump and Dump)</a><ul><li><a href=#so-what-went-wrong->So, What went wrong ?</a></li></ul></li></ul></nav></div></div><div class=post-content><blockquote><p>Most of the content in this post is either from or inspired by <a href=https://arxiv.org/abs/2003.03810>this</a> paper. If you would rather read it,
go ahead and skip this post.</p></blockquote><h2 id=decentralized-finance>Decentralized Finance.</h2><p><a href=https://www.securities.io/what-is-defi/>Decentralized Finance</a> is an effort to bring the benefits of distributed ledger technologies to the real world of finance. Instead of the financial institution <a href=https://en.wikipedia.org/wiki/Know_your_customer>knowing their customers</a> to ensure their trust is well placed, you are able to transparently view all of the <a href=https://blogchain.wtf/post/getting-started-with-ethereum/>Smart Contracts</a>, security practices, security audits to effectively <em>Know Your Bank</em>. Even if you are not well versed with the jargons and tech related to the contract, you can still check the security audit, and see how many of the high severity bugs have been fixed. That should give you a pretty good idea of the practices of that community. The known practices of DeFi have been the overcollateralized loans where you have to first lend some currency into their pool, use them as collateral to take some other currency as a loan. This system welcomes a whole lot of trading opportunities as is and they have been put to use for quite some time now. So what does flash loan bring to the table ?</p><h2 id=flash-loans-the-new-kid-on-the-defi-block-well-relatively->Flash Loans, The New Kid on the DeFi Block. <em>(Well Relatively !)</em></h2><p>Flash Loans, pioneered by <a href=https://aave.com>AAVE</a>, is a method of borrowing any amount of any currency with zero upfront collateral, but only using a <strong>smart contract</strong>. So in essence, you are able to borrow <em>any</em> amount of <em>any</em> currency you want (How much ever the exchange has, of course), <em>anonymously</em> without staking <em>anything</em>.</p><p><img src=../../images/WaitWhatMatrix.webp alt="Wait, What ?"></p><ul><li><h3 id=okay--if-that-is-possible-then-whats-the-catch->Okay , If that is possible, then what&rsquo;s the catch ?</h3><ul><li>The loaned amount has to be returned in the same transaction. If you don&rsquo;t, then the smart contract <code>revert</code>s your transaction so now it&rsquo;s like you never even borrowed the amount.</li></ul><blockquote><p>Since, the <code>revert</code> in Ethereum resets the state back to the previous one, Your balances are all invalidated, So it&rsquo;s like the currency note you are carrying suddenly became invalid. 😉 Any and all transactions that you performed with the borrowed amount now stand invalidated.</p></blockquote><ul><li>You still pay the gas for the transaction.</li><li>You pay marginal fees to the Flash Loan Provider, If the transaction goes through properly.</li></ul></li><li><h3 id=if-we-return-the-money-as-soon-as-we-borrow-whats-the-use->If we return the money as soon as we borrow, What&rsquo;s the use ?</h3><blockquote><p>All use-cases are listed in the <a href=https://medium.com/aave/sneak-peek-at-flash-loans-f2b28a394d62>AAVE&rsquo;s blog</a></p></blockquote><ul><li><a href=https://twitter.com/JordanLzG/status/1230484691679088640>Collateral Swapping</a></li><li>Interest Rate Change</li><li>Self Liquidation</li><li>Arbitrage Opportunities</li></ul><blockquote><p>Mind you, all the transactions are to be executed by a Contract.</p></blockquote></li></ul><blockquote><p>I&rsquo;ll now stop about Flash Loans as it&rsquo;s a intricate topic to explain.
Go through <a href=https://aave.com/flash-loans>this</a> for more details. Let&rsquo;s now get into the attacks that happened.</p></blockquote><h2 id=attack-1-pump-and-dump>Attack #1 (Pump and Dump)</h2><blockquote><p>The following explanations are superficial, If you need exact details, read the paper or disclosures by bZx.</p></blockquote><p>This attack involved pumping an exchange with enormous amount of one currency, borrowing the other, Which will lead to an imbalance of the prices</p><table><thead><tr><th>Steps</th><th>Assets</th></tr></thead><tbody><tr><td>Borrow 10,000 Ether from <a href=https://dydx.exchange>dydx</a> (At the time of writing this, It values to 2.3M USD 💸 )</td><td>10k ETH</td></tr><tr><td>Deposit 5,500 ETH to <a href=https://compound.finance>Compond</a></td><td>4.5k ETH, Position in Compound</td></tr><tr><td>Using the deposited ETH as collateral loan 112 <a href=https://wbtc.network/>WBTC</a> (Wrapped Bitcoin)</td><td>4.5k ETH, 112 WBTC</td></tr><tr><td>Take up a short position with 5x Margin at <a href=https://bzx.network>bZx</a> with 1300 ETH against WBTC.</td><td>3.2K ETH, 112WBTC, Position in bZx</td></tr><tr><td>Exchange the 112 WBTC to 6871 ETH in <a href=https://uniswap.org>Uniswap</a></td><td>10,071 ETH, Compund & bZx Positions</td></tr><tr><td>Payback the 10k ETH flash loan to dydx</td><td>71 ETH, Compond & bZx positions</td></tr></tbody></table><blockquote><p>If fourth transaction doesn&rsquo;t make any sense, Just imagine it as a genie driving the price of WBTC to a sky high.</p></blockquote><p>So, Outright the attacker a 71 ETH profit, but that isn&rsquo;t flashy ⚡ enough.</p><p>The two positions are what give the attacker a whopping 350k USD profit. So, at the risk of sounding complicated, let&rsquo;s dissect this. When the attacker opened a short position in bZx, bZx bought 51 WBTC on behalf of him on Uniswap and at the time, Uniswap had (2817.77 ETH & 77.09 WBTC) making the exchange rate</p><p>$${2817.77\ ETH \over 77.09\ WBTC} = {36.58441558441559\ ETH/WBTC}$$</p><p>But the moment bZx tried to buy WBTC on behalf of the attacker giving its 5637.2 ETH, The new price becomes</p><p>$${2817.77 + 5637.2 \over 77.09} = {109.67661175249707\ ETH/WBTC}$$</p><p>This stellar rise in the price actually <a href=https://www.investopedia.com/terms/d/default2.asp>defaults</a> the position in bZx, as the borrwed WBTC&rsquo;s total value is now way over that was collateralized. So this position was left by the attacker to be liquidated by bZx as he got what he wanted, The stellar rise in the WBTC-ETH price. Now he can just return the 112 WBTC that he borrowed from Compound in <strong>Step 2</strong> at a much much greater value, giving him a hefty profit.</p><blockquote><p>The <a href=https://arxiv.org/abs/2003.03810>Paper</a> considers this attack under-performing and goes on to explain which of the trade parameters
could have been altered to realize a much greater profit 😳, Do give it read as they solve it as an optimization problem, Some part of
which went way over my head.😲</p></blockquote><ul><li><h3 id=so-what-went-wrong->So, What went wrong ?</h3></li></ul><p>The smart contract missed a sanity check which would not let transactions that default themselves go through, In this particular case.</p></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>Kiran Hegde</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2020-07-15</span></p></div><footer class=post-footer><div class=post-tags><a href=../../tags/defi/>defi</a>
<a href=../../tags/security/>security</a>
<a href=../../tags/aave/>aave</a></div><nav class=post-nav><a class=next href=../../post/getting-started-with-ethereum/><span class="next-text nav-default">Getting Started With Ethereum</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname==='localhost')return;var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;var disqus_shortname='blogchain-wtf';dsq.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:kiranhegde619@gmail.com class="fa fa-email fa-3x" title=email></a><a href=https://stackoverflow.com/users/10238237/kiran-hegde class="fa fa-stack-overflow fa-3x" title=stack-overflow></a><a href=https://twitter.com/Y0ungb100d21 class="fa fa-twitter fa-3x" title=twitter></a><a href=https://t.me/TabSpace class="fa fa-telegram fa-3x" title=telegram></a><a href=http://linkedin.com/in/kiranravihegde class="fa fa-linkedin fa-3x" title=linkedin></a><a href=http://github.com/HankiGreed class="fa fa-github fa-3x" title=github></a><a href=http://blogchain.wtf/index.xml type=application/rss+xml class="fa fa-rss fa-3x" title=rss></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Theme -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2020
<span class=heart><i class="iconfont icon-heart"></i></span><span class=author>Kiran Hegde</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/raphael@2.2.7/raphael.min.js integrity="sha256-67By+NpOtm9ka1R6xpUefeGOY8kWWHHRAKlvaTJ7ONI=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/flowchart.js@1.8.0/release/flowchart.min.js integrity="sha256-zNGWjubXoY6rb5MnmpBNefO0RgoVYfle9p0tvOQM+6k=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.js integrity="sha256-4O4pS1SH31ZqrSO2A/2QJTVjTPqVe+jnYgOWUVr7EEc=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/snapsvg@0.5.1/dist/snap.svg-min.js integrity="sha256-oI+elz+sIm+jpn8F/qEspKoKveTc5uKeFHNNVexe6d8=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/underscore@1.8.3/underscore-min.js integrity="sha256-obZACiHd7gkOk9iIL/pimWMTJ4W/pBsKu+oZnSeBIek=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/gh/bramp/js-sequence-diagrams@2.0.1/dist/sequence-diagram-min.js integrity=sha384-8748Vn52gHJYJI0XEuPB2QlPVNUkJlJn9tHqKec6J3q2r9l8fvRxrgn/E5ZHV0sP crossorigin=anonymous></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/bramp/js-sequence-diagrams@2.0.1/dist/sequence-diagram-min.css integrity=sha384-6QbLKJMz5dS3adWSeINZe74uSydBGFbnzaAYmp+tKyq60S7H2p6V7g1TysM5lAaF crossorigin=anonymous><script type=text/javascript src=../../js/main.min.d7b7ada643c9c1a983026e177f141f7363b4640d619caf01d8831a6718cd44ea.js></script><script type=text/javascript>window.MathJax={TeX:{equationNumbers:{autoNumber:"AMS"}},showProcessingMessages:false,messageStyle:'none'};</script><script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin=anonymous></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-169050086-1','auto');ga('set','anonymizeIp',true);ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>